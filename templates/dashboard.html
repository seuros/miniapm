{% extends "layout.html" %}

{% block title %}Dashboard - MiniAPM{% endblock %}

{% block project_selector %}
{% if ctx.projects_enabled %}
<form method="POST" action="/projects/switch" class="project-selector">
    <select name="slug" onchange="this.form.submit()">
        {% for project in ctx.projects %}
        <option value="{{ project.slug }}" {% if ctx.is_current_project(project.id) %}selected{% endif %}>
            {{ project.name }}
        </option>
        {% endfor %}
    </select>
</form>
{% endif %}
{% endblock %}

{% block content %}
<h1>Dashboard</h1>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ requests_24h }}</div>
        <div class="stat-label">Requests (24h)</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ errors_24h }}</div>
        <div class="stat-label">Errors (24h)</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ avg_ms }} ms</div>
        <div class="stat-label">Avg Response</div>
    </div>
</div>

<div class="grid-2">
    <section class="card">
        <h2>Recent Errors</h2>
        {% if recent_errors.is_empty() %}
        <p class="empty">No errors in the last 24 hours</p>
        {% else %}
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Exception</th>
                        <th class="num">Count</th>
                        <th>Last Seen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for error in recent_errors %}
                    <tr>
                        <td><a href="/errors/{{ error.id }}">{{ error.exception_class }}</a></td>
                        <td class="num">{{ error.occurrence_count }}</td>
                        <td>{{ error.last_seen_at }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </section>

    <section class="card">
        <h2>Slowest Routes</h2>
        {% if slow_routes.is_empty() %}
        <p class="empty">No data yet</p>
        {% else %}
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Route</th>
                        <th class="num">Avg</th>
                        <th class="num">Reqs</th>
                    </tr>
                </thead>
                <tbody>
                    {% for route in slow_routes %}
                    <tr>
                        <td class="route-cell">{{ route.method }} {{ route.path }}</td>
                        <td class="num">{{ route.avg_ms }} ms</td>
                        <td class="num">{{ route.request_count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </section>
</div>
{% endblock %}
